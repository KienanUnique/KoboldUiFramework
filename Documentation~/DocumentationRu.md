# Сервис окон

## Интерфейс
- `IWindowsService.CurrentWindow` возвращает верхнее окно стека или `null`, если стек пуст.
- `IWindowsService.IsOpened<TWindow>()` проверяет, соответствует ли текущее окно запрошенному типу.

### OpenWindow<TWindow>(Action onComplete = null)
- Получает из контейнера Zenject привязанное окно и игнорирует запрос, если это окно уже открыто.
- Если следующее окно помечено как всплывающее, предыдущее переводится в состояние `EWindowState.NonFocused`, иначе закрывается.
- Перед показом ожидает завершения метода `AWindowBase.Initialize`.
- Добавляет окно в стек, обновляет порядок слоев и запускает переход в состояние `EWindowState.Active`.
- Колбэк, переданный в параметре `onComplete`, ставится в очередь сразу после действия открытия.

### CloseWindow(Action onComplete = null, bool useBackLogicIgnorableChecks = true)
- Удаляет текущее окно из стека и переводит его в состояние `EWindowState.Closed`.
- При `useBackLogicIgnorableChecks = true` запрос пропускается, если окно разрешает игнорировать возврат.
- После закрытия планирует повторное открытие предыдущего окна, если оно есть.
- Колбэк выполняется строго после операции закрытия.

### CloseToWindow<TWindow>(Action onComplete = null, bool useBackLogicIgnorableChecks = true)
- Закрывает окна, пока нужное окно не станет текущим; если целевого окна нет в стеке, ничего не происходит.
- Прерывает выполнение, когда включена проверка `useBackLogicIgnorableChecks` и встречается окно, допускающее игнорирование возврата.
- После обрезки стека повторно активирует новое верхнее окно.

### Модель исполнения
- Все UI-действия попадают в очередь `TaskRunner`, что гарантирует последовательное выполнение.
- `LocalWindowsService` и `ProjectWindowsService` отличаются только контекстом, в котором устанавливаются их инсталлеры.

# Окна
- Наследуйте окна от `AWindow`; префаб должен содержать `CanvasGroup`.
- Поле `_isPopup` определяет, теряет ли предыдущее окно фокус (`true`) или закрывается (`false`).
- Поле `_isBackLogicIgnorable` разрешает окну игнорировать возврат, когда включена проверка `useBackLogicIgnorableChecks`.
- Переопределите `AddControllers` и вызывайте `AddController<TController, TView>(viewInstance)` для регистрации каждой пары контроллер/представление.
- `AddController` создаёт контроллер через Zenject, внедряет зависимости в объект окна, инициализирует представление и контроллер и сразу закрывает контроллер.
- Представления-заглушки из списка `_animatedEmptyViews` подключаются автоматически в ходе инициализации.
- `SetState` рассылает состояние всем контроллерам и возвращает одно параллельное действие, объединяющее их ответы.
- `ApplyOrder` устанавливает индекс среди соседей; `WindowsOrdersManager` использует его для корректного порядка наложения.
- `InstallBindings` сохраняет ссылку на контейнер и вызывается из `DiContainerExtensions.BindWindowFromPrefab`.

Дополнительно `AWindowBase` предоставляет:
- Свойства `IsPopup`, `IsBackLogicIgnorable`, `Name` и `IsInitialized`.
- Метод `WaitInitialization`, возвращающий действие, завершающееся после вызова `Initialize`.

# Контроллеры
- Контроллеры наследуются от `AUiController<TView>` и получают представление через внедрение Zenject.
- Метод `SetState` переключает состояния `Active`, `NonFocused` и `Closed`, вызывая `OnOpen`, `OnFocusRemove` или `OnClose` после постановки действий представления в очередь.
- Переопределяйте `Initialize`, `OnOpen`, `OnClose` и `OnFocusRemove`, чтобы добавлять логику.
- Метод `CloseInstantly` скрывает представление без анимаций.

# Представления
- Все представления реализуют `IUiView` и являются компонентами `MonoBehaviour`.
- `AUiView` содержит пустые виртуальные обработчики и по умолчанию возвращает из пула `EmptyAction`.
- `AUiSimpleView` включает и выключает GameObject при открытии и закрытии, переиспользуя базовую логику фокуса.
- `AUiAnimatedView` воспроизводит назначенные анимации появления и скрытия и использует поведение `AUiView`, если анимации отсутствуют.
- `AnimatedEmptyView` — готовая анимированная заглушка на базе `AUiAnimatedView`.

# Анимации
- Для пользовательских анимаций наследуйтесь от `AUiAnimation<TParams>` или `AUiAnimationBase`.
- Флаг `_needWaitAnimation` заставляет вызывать ожидающее действие, иначе возвращается мгновенное пустое действие.
- Анимация может использовать внедрённые параметры по умолчанию или переопределённые сериализованные параметры; для второго варианта отключите `_useDefaultParameters`.
- Встроенные анимации: затухание, масштабирование и слайд, каждая реализована через собственный tween DOTween.
- Параметры по умолчанию (`FadeAnimationParameters`, `ScaleAnimationParameters`, `SlideAnimationParameters`) содержат настройки времени и сглаживания и создаются как `ScriptableObject`.

# Действия и пул
- `IUiActionsPool` создаёт и переиспользует действия для ожидания твинов, колбэков, ожидания инициализации, команд сервиса окон и параллельных обёрток.
- `UiActionsPool.Initialize` формирует отдельные object pool для каждого типа действия.
- Все действия наследуются от `AUiAction`, выполняют логику в `Start` и после завершения возвращаются в пул.
- `TaskRunner` последовательно выполняет очередь действий и освобождает оставшиеся элементы при завершении работы.

# Коллекции
- `AUiListCollection<TView>` создаёт новые элементы и уничтожает их при удалении.
- `AUiPooledCollection<TView>` переиспользует элементы, возвращая их во внутренний пул методом `ReturnToPool`.
- Элементы коллекций реализуют `IUiCollectionView`; `AUiCollectionView` предоставляет `SetParent` и `Destroy`, а `AUiSimpleCollectionView` переключает активность в `Appear`/`Disappear`.

# Установка
- Привязывайте параметры анимаций через `DefaultAnimationsInstaller`.
- Регистрируйте `LocalWindowsServiceInstaller` и `ProjectWindowsServiceInstaller` в соответствующих контекстах Zenject.
- Используйте `DiContainer.BindWindowFromPrefab(canvas, prefab)` для создания и привязки окон; хелпер добавляет окно под указанный canvas, ставит его в очередь на внедрение и биндинг как singleton.
